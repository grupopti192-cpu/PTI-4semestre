<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Carrinho</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="icon" type="image/png" href="media/icon.png">
</head>

<body>
<header class="cabecalho">
  <a href="index.html" class="voltar-nav"><i class="fas fa-arrow-left"></i> Voltar</a>
  <h2>Meu Carrinho</h2>
  <div class="loginCadastro"></div>
</header>

<main class="container" id="carrinho">
  <div id="conteudoCarrinho"></div>
</main>

<script src="/carrinho.js"></script>

<script>
  const FRETE = 0.00;
  const TAXA_SERVICO = 5.00;
  const DESCONTO_CUPOM = 10.00;

  function formatBR(v){
    return v.toFixed(2).replace('.', ',');
  }

  function renderizarCarrinho() {
    const conteudo = document.getElementById("conteudoCarrinho");
    const carrinho = getCarrinho(); // função do seu carrinho.js

    if (!carrinho || carrinho.length === 0) {
      conteudo.innerHTML = `
        <div class="carrinho-vazio">
          <i class="fas fa-shopping-cart"></i>
          <h2>Seu carrinho está vazio!</h2>
          <p>Parece que você ainda não adicionou nenhum produto.</p>
          <a href="index.html" class="btn-voltar"><i class="fas fa-arrow-left"></i> Voltar à Home</a>
        </div>`;
      return;
    }

    const totalItens = carrinho.reduce((s, it) => s + (it.quantidade || 0), 0);
    const subtotal = carrinho.reduce((s, it) => s + (it.preco * (it.quantidade || 0)), 0);

    const frete = Number(FRETE);
    const taxaServico = Number(TAXA_SERVICO);
    const desconto = Number(DESCONTO_CUPOM);
    const totalFinal = Math.max(0, subtotal + frete + taxaServico - desconto);

    let html = `
      <div class="carrinho-layout">
        <section class="carrinho-itens-section">
          <h3><i class="fas fa-list"></i> Itens (${totalItens})</h3>
    `;

    carrinho.forEach(item => {
      const itemTotal = (item.preco * (item.quantidade || 0));
      html += `
        <div class="carrinho-item">
          <img src="${item.imagem}" class="item-imagem" onerror="this.src='/media/placeholder.png'">
        
          <div class="item-info">
            <div class="item-nome">${item.nome}</div>
            <div class="item-preco">R$ ${formatBR(itemTotal)}</div>
          </div>

          <div class="item-quantidade">
            <button class="btn-qtd" onclick="setQuantidade(${item.id}, ${Math.max(0,(item.quantidade||0) - 1)})">-</button>
            <span>${item.quantidade}</span>
            <button class="btn-qtd" onclick="setQuantidade(${item.id}, ${Number(item.quantidade||0) + 1})">+</button>
          </div>
          <button class="btn-remover" onclick="removerDoCarrinho(${item.id})" title="Remover"><i class="fas fa-trash"></i></button>
        </div>
      `;
    });

    html += `
      <p style="text-align:center;margin-top:20px;color:#555;">
        <i class="fas fa-info-circle"></i> Pedidos de diferentes farmácias serão cobrados separadamente.
      </p>
      </section>
    `;

    html += `
      <section class="checkout-summary-section">
        <h3><i class="fas fa-calculator"></i> Total do Pedido</h3>

        <table class="resumo-pedido">
          <tr><th>Subtotal (${totalItens} ${totalItens === 1 ? 'item' : 'itens'})</th><td>R$ ${formatBR(subtotal)}</td></tr>
          <tr><th>Frete</th><td>R$ ${formatBR(frete)}</td></tr>
          <tr><th>Taxa de Serviço</th><td>R$ ${formatBR(taxaServico)}</td></tr>
          <tr><th>Desconto (Cupom)</th><td style="color:#28a745;">- R$ ${formatBR(desconto)}</td></tr>
          <tr class="total-line"><th>Total a Pagar</th><td>R$ ${formatBR(totalFinal)}</td></tr>
        </table>

        <a href="checkout.html" class="btn-checkout"><i class="fas fa-credit-card"></i> Ir para o Pagamento</a>
      </section>
    </div>
    `;

    conteudo.innerHTML = html;
  }

  document.addEventListener("DOMContentLoaded", () => {
    renderizarCarrinho();
    window.addEventListener("storage", renderizarCarrinho);
  });

  const _orig_setQuantidade = window.setQuantidade || function(){};
  window.setQuantidade = function(id, qtd){
    _orig_setQuantidade(id, qtd);
    renderizarCarrinho();
  };

  const _orig_removerDoCarrinho = window.removerDoCarrinho || function(){};
  window.removerDoCarrinho = function(id){
    _orig_removerDoCarrinho(id);
    renderizarCarrinho();
  };
</script>
<script src="auth.js"></script>

</body>
</html>