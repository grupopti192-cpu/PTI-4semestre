<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Área do Cliente - Minha Farmácia</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>

<body>
  <header class="cabecalho">
    <div class="logo">
      <a href="index.html"><p>Minha Farmácia Delivery</p></a>
    </div>
    <h2>Área do Cliente</h2>
    <div id="headerUserArea" class="localizacao" style="display:flex; gap:15px; width:80px; justify-content:flex-end;"></div>
  </header>

  <main class="container">
    <section class="perfil-header">
      <i class="fas fa-user-circle"></i>
      <div class="perfil-info">
        <h2 id="perfilNome">Carregando...</h2>
        <p id="perfilEmail"></p>
      </div>
    </section>

    <section style="padding:0;">
      <div class="perfil-tabs">
        <button class="active" onclick="showPerfilTab(event,'pedidos')"><i class="fas fa-history"></i> Pedidos</button>
        <button onclick="showPerfilTab(event,'endereco')"><i class="fas fa-map-marker-alt"></i> Endereço</button>
        <button onclick="showPerfilTab(event,'dados')"><i class="fas fa-user-edit"></i> Dados Pessoais</button>
      </div>

      <div style="padding:20px;">
        <div id="pedidos" class="tab-content-perfil active-content">
          <h3>Histórico de Pedidos</h3>
          <div id="listaPedidos"></div>
        </div>

        <div id="endereco" class="tab-content-perfil">
          <h3>Endereço Cadastrado</h3>
          <div id="enderecoAtual" style="margin-bottom:20px;"></div>

          <form id="formEndereco" class="cadastro-form">
            <h4><i class="fas fa-map-marker-alt"></i> Atualizar Endereço</h4>
            <div class="form-group">
              <label for="novoEndereco">Endereço Completo</label>
              <input type="text" id="novoEndereco" placeholder="Ex: Rua das Flores, 123 - Centro, Curitiba/PR" required>
            </div>
            <button type="submit" class="cadastro-btn" style="width:100%; margin-top:10px;">
              <i class="fas fa-save"></i> Salvar Endereço
            </button>
          </form>
        </div>

        <div id="dados" class="tab-content-perfil">
          <h3>Atualizar Informações</h3>
          <form id="formDados" class="cadastro-form">
            <div class="form-group">
              <label for="nome-p">Nome Completo</label>
              <input type="text" id="nome-p" required>
            </div>
            <div class="form-group">
              <label for="email-p">E-mail</label>
              <input type="email" id="email-p" required>
            </div>
            <div class="form-group">
              <label for="telefone-p">Telefone</label>
              <input type="tel" id="telefone-p">
            </div>
            <button type="submit" class="cadastro-btn"><i class="fas fa-save"></i> Salvar Alterações</button>
          </form>
        </div>
      </div>
    </section>
  </main>

  <script>
    function showPerfilTab(event, tabId) {
      document.querySelectorAll('.perfil-tabs button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content-perfil').forEach(c => c.classList.remove('active-content'));
      event.currentTarget.classList.add('active');
      document.getElementById(tabId).classList.add('active-content');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const usuarioJson = sessionStorage.getItem('usuarioLogado');
      const tipo = sessionStorage.getItem('tipoUsuario');

      if (!usuarioJson || !tipo) {
        sessionStorage.clear();
        window.location.href = 'login.html';
        return;
      }

      if (tipo !== 'cliente') {
        alert('Acesso restrito a clientes.');
        window.location.href = 'index.html';
        return;
      }

      const usuario = JSON.parse(usuarioJson);
      const headerArea = document.getElementById('headerUserArea');

      if (headerArea && headerArea.children.length === 0) {
        headerArea.innerHTML = `<a href="#" id="logout" title="Sair"><i class="fas fa-sign-out-alt"></i> Sair</a>`;
        document.getElementById('logout').addEventListener('click', () => {
          sessionStorage.clear();
          window.location.href = 'index.html';
        });
      }

      document.getElementById('perfilNome').textContent = usuario.nome || '';
      document.getElementById('perfilEmail').textContent = usuario.email || '';
      document.getElementById('nome-p').value = usuario.nome || '';
      document.getElementById('email-p').value = usuario.email || '';
      document.getElementById('telefone-p').value = usuario.telefone || '';

      const enderecoDiv = document.getElementById('enderecoAtual');
      enderecoDiv.innerHTML = usuario.endereco
        ? `<p><i class="fas fa-home"></i> ${usuario.endereco}</p>`
        : `<p style="color:gray;">Nenhum endereço cadastrado ainda.</p>`;

      document.getElementById('formEndereco').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const novoEndereco = document.getElementById('novoEndereco').value.trim();
        if (!novoEndereco) return alert('Informe o endereço completo.');

        try {
          const resp = await fetch(`http://localhost:3000/clientes/${usuario.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endereco: novoEndereco })
          });

          const data = await resp.json();
          if (data.sucesso) {
            usuario.endereco = novoEndereco;
            sessionStorage.setItem('usuarioLogado', JSON.stringify(usuario));
            enderecoDiv.innerHTML = `<p><i class="fas fa-home"></i> ${novoEndereco}</p>`;
            ev.target.reset();
            alert('Endereço atualizado com sucesso!');
          } else {
            alert('Erro ao salvar endereço.');
          }
        } catch (err) {
          console.error(err);
          alert('Erro de comunicação com o servidor.');
        }
      });

      document.getElementById('formDados').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const nome = document.getElementById('nome-p').value.trim();
        const email = document.getElementById('email-p').value.trim();
        const telefone = document.getElementById('telefone-p').value.trim();

        try {
          const resp = await fetch(`http://localhost:3000/clientes/${usuario.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nome, email, telefone })
          });

          const data = await resp.json();
          if (data.sucesso) {
            sessionStorage.setItem('usuarioLogado', JSON.stringify(data.cliente));
            document.getElementById('perfilNome').textContent = nome;
            document.getElementById('perfilEmail').textContent = email;
            alert('Dados atualizados com sucesso!');
          } else {
            alert('Erro ao atualizar dados.');
          }
        } catch (err) {
          console.error(err);
          alert('Erro de comunicação com o servidor.');
        }
      });
    });
  </script>

  <script src="auth.js"></script>
</body>
</html>
