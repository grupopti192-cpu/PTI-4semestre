<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Área do Cliente - Minha Farmácia</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="icon" type="image/png" href="media/icon.png">
</head>

<body>
  <header class="cabecalho">
      <a class="logo" href="index.html">
          <img src="/media/icon.png">
          <p>Minha Farmácia Delivery</p>
      </a>
    <h2>Área do Cliente</h2>
    <div id="headerUserArea" class="localizacao" style="display:flex; gap:15px; width:80px; justify-content:flex-end;"></div>
  </header>

  <main class="container">

    <section class="perfil-header">
      <i class="fas fa-user-circle"></i>
      <div class="perfil-info">
        <h2 id="perfilNome">Carregando...</h2>
        <p id="perfilEmail"></p>
      </div>
    </section>

    <section style="padding:0;">
      <div class="perfil-tabs">
        <button class="active" onclick="showPerfilTab(event,'pedidos')"><i class="fas fa-history"></i> Pedidos</button>
        <button onclick="showPerfilTab(event,'endereco')"><i class="fas fa-map-marker-alt"></i> Endereço</button>
        <button onclick="showPerfilTab(event,'dados')"><i class="fas fa-user-edit"></i> Dados Pessoais</button>
      </div>

      <div style="padding:20px;">

        <div id="pedidos" class="tab-content-perfil active-content">
          <h3>Histórico de Pedidos</h3>
        <div class="pedido-card">
          <div class="pedido-header">
            <span class="pedido-id">Pedido #10293</span>
            <span class="pedido-status entregue">Entregue</span>
          </div>

          <div class="pedido-info">
            <p><i class="fas fa-calendar"></i> 12/11/2025 às 14:32</p>
            <p><i class="fas fa-store"></i> Farmácia Popular</p>
            <p><i class="fas fa-box"></i> 3 itens</p>
          </div>

          <div class="pedido-total">
            Total: <strong>R$ 89,70</strong>
          </div>

          <button class="pedido-btn">Ver detalhes</button>
        </div>

<div class="pedido-card">
  <div class="pedido-header">
    <span class="pedido-id">Pedido #10288</span>
    <span class="pedido-status em-transito">Em Trânsito</span>
  </div>

  <div class="pedido-info">
    <p><i class="fas fa-calendar"></i> 10/11/2025 às 18:50</p>
    <p><i class="fas fa-store"></i> UltraFarma</p>
    <p><i class="fas fa-box"></i> 1 item</p>
  </div>

  <div class="pedido-total">
    Total: <strong>R$ 32,90</strong>
  </div>

  <button class="pedido-btn">Ver detalhes</button>
</div>

<div class="pedido-card">
  <div class="pedido-header">
    <span class="pedido-id">Pedido #10274</span>
    <span class="pedido-status cancelado">Cancelado</span>
  </div>

  <div class="pedido-info">
    <p><i class="fas fa-calendar"></i> 03/11/2025 às 09:22</p>
    <p><i class="fas fa-store"></i> FarmaExpress</p>
    <p><i class="fas fa-box"></i> 5 itens</p>
  </div>

  <div class="pedido-total">
    Total: <strong>R$ 154,40</strong>
  </div>

  <button class="pedido-btn">Ver detalhes</button>
</div>



        </div>

        <div id="endereco" class="tab-content-perfil">
          <h3>Endereço Cadastrado</h3>
          <div id="enderecoAtual" style="margin-bottom:20px;"></div>

          <form id="formEndereco" class="cadastro-form">
            <h4><i class="fas fa-map-marker-alt"></i> Atualizar Endereço</h4>
            <div class="form-group">
              <label for="novoEndereco">Endereço Completo</label>
              <input type="text" id="novoEndereco" placeholder="Rua Dr. Vila Nova, 228, São Paulo, SP" required>
            </div>
            <button type="submit" class="cadastro-btn" style="width:100%; margin-top:10px;">
              <i class="fas fa-save"></i> Salvar Endereço
            </button>
          </form>
        </div>

        <div id="dados" class="tab-content-perfil">
          <h3>Atualizar Informações</h3>
          <form id="formDados" class="cadastro-form">
            <div class="form-group">
              <label for="nome-p">Nome Completo</label>
              <input type="text" id="nome-p" required>
            </div>
            <div class="form-group">
              <label for="email-p">E-mail</label>
              <input type="email" id="email-p" required>
            </div>
            <div class="form-group">
              <label for="telefone-p">Telefone</label>
              <input type="tel" id="telefone-p">
            </div>
            <button type="submit" class="cadastro-btn"><i class="fas fa-save"></i> Salvar Alterações</button>
          </form>
        </div>

      </div>
    </section>

  </main>

  <script>
    function showPerfilTab(event, tabId) {
      document.querySelectorAll('.perfil-tabs button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content-perfil').forEach(c => c.classList.remove('active-content'));
      event.currentTarget.classList.add('active');
      document.getElementById(tabId).classList.add('active-content');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const usuarioJson = sessionStorage.getItem('usuarioLogado');
      const tipo = sessionStorage.getItem('tipoUsuario');

      if (!usuarioJson || !tipo) {
        sessionStorage.clear();
        window.location.href = 'login.html';
        return;
      }

      if (tipo !== 'cliente') {
        alert('Acesso restrito a clientes.');
        window.location.href = 'index.html';
        return;
      }

      const usuario = JSON.parse(usuarioJson);
      configurarLogout();

      await carregarCliente(usuario.id);

      configurarAtualizacaoEndereco(usuario.id);
      configurarAtualizacaoDados(usuario.id);
    });

    function configurarLogout() {
      const headerArea = document.getElementById('headerUserArea');
      headerArea.innerHTML = `<a href="#" id="logout" title="Sair"><i class="fas fa-sign-out-alt"></i> Sair</a>`;
      document.getElementById('logout').addEventListener('click', () => {
        sessionStorage.clear();
        window.location.href = 'index.html';
      });
    }

    async function carregarCliente(id) {
      try {
        const resp = await fetch(`http://localhost:3000/clientes/${id}`);
        const cliente = await resp.json();

        document.getElementById('perfilNome').textContent = cliente.nome;
        document.getElementById('perfilEmail').textContent = cliente.email;

        document.getElementById('nome-p').value = cliente.nome;
        document.getElementById('email-p').value = cliente.email;
        document.getElementById('telefone-p').value = cliente.telefone || "";

        const enderecoDiv = document.getElementById('enderecoAtual');
        if (cliente.endereco) {
          enderecoDiv.innerHTML = `<p><i class="fas fa-home" style="color: #007bff"></i> ${cliente.endereco}</p>`;
        } else {
          enderecoDiv.innerHTML = `<p style="color:gray;">Nenhum endereço cadastrado ainda.</p>`;
        }

      } catch (err) {
        console.error(err);
        alert('Erro ao carregar dados do cliente.');
      }
    }

    function configurarAtualizacaoEndereco(id) {
      document.getElementById('formEndereco').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const novoEndereco = document.getElementById('novoEndereco').value.trim();

        if (!novoEndereco) return alert("Informe o endereço completo.");

        try {
          const resp = await fetch(`http://localhost:3000/clientes/${id}`, {
            method: 'PUT',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ endereco: novoEndereco })
          });

          const data = await resp.json();

          if (data.sucesso) {
            alert("Endereço atualizado!");
            await carregarCliente(id);
            ev.target.reset();
          } else {
            alert("Erro ao atualizar endereço.");
          }

        } catch (err) {
          console.error(err);
          alert('Erro de comunicação com o servidor.');
        }
      });
    }

    function configurarAtualizacaoDados(id) {
      document.getElementById('formDados').addEventListener('submit', async (ev) => {
        ev.preventDefault();

        const nome = document.getElementById('nome-p').value.trim();
        const email = document.getElementById('email-p').value.trim();
        const telefone = document.getElementById('telefone-p').value.trim();

        try {
          const resp = await fetch(`http://localhost:3000/clientes/${id}`, {
            method: 'PUT',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nome, email, telefone })
          });

          const data = await resp.json();

          if (data.sucesso) {
            alert("Dados atualizados!");
            await carregarCliente(id);
          } else {
            alert("Erro ao atualizar dados.");
          }

        } catch (err) {
          console.error(err);
          alert('Erro de comunicação com o servidor.');
        }
      });
    }
  </script>

  <script src="auth.js"></script>
</body>
</html>
